{% extends "base.html" %}
{% block content %}
<div id="navbar" class="fixed top-0 left-0 w-full z-50 bg-[#FFEFEF] backdrop-blur-sm shadow-sm">
  <div class="max-w-7xl mx-auto px-6 py-2 flex items-center gap-2">
    <a href="{{ url_for('main.home') }}" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
      <img
        src="{{ url_for('static', filename='img/turt-logo.png') }}"
        alt="Turtle Trips logo"
        class="h-12 w-auto"
      />
      <span class="text-xl font-extrabold title-lower-serif tracking-tight">turtle trips.</span>
    </a>
  </div>
  <div class="navbar-underline h-[1px] w-full bg-black/20"></div>
</div>

<style>
/* ✨ simple fade animation */
.fade-in {
  opacity: 0;
  transform: translateY(8px);
  animation: fadeInUp 0.6s ease-out forwards;
}
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

<section class="pt-8 sm:pt-12">
  <h2 class="text-3xl mb-2 sm:text-4xl font-extrabold text-center tracking-tight title-lower-serif fade-in title-3d">
    <span id="trip-title">your trips!</span>
  </h2>

  <!-- top action bar -->
  <div class="max-w-6xl mx-auto mb-4 flex items-center justify-between fade-in">
    <button id="back-btn" class="hidden px-6 py-3 bg-black text-white rounded-full text-sm font-medium 
      hover:bg-slate-800 transition-all transform hover:scale-105 duration-200">
      ← back
    </button>
  </div>

  <!-- two column canvas -->
  <div id="view" class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 items-start fade-in">
    <div id="plans-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 md:col-span-2"></div>

    <div id="map-col" class="hidden opacity-0 transition-opacity duration-500">
      <div class="md:sticky md:top-6">
        <div class="bg-white/80 rounded-2xl p-3 shadow-sm">
          <div id="map" class="w-full h-[75vh] rounded-xl bg-slate-100"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fallback/raw -->
  <div id="raw-block" class="mt-8 hidden max-w-6xl mx-auto">
    <h2 class="text-sm font-semibold text-slate-600 mb-2">raw output</h2>
    <pre class="bg-white/80 rounded-xl p-4 shadow-sm text-xs overflow-x-auto" id="raw-pre"></pre>
  </div>

  <!-- Turtle Mascot + speech -->
  <div id="turtle-mascot-wrapper" class="fixed left-2 right-2 bottom-12 z-50 flex flex-col items-start transition-all duration-300">
    <div id="turtle-speech" class="mb-2 max-w-xs px-4 py-2 bg-white/90 backdrop-blur-sm rounded-2xl shadow-sm text-sm font-medium text-slate-800"></div>
    <img id="turtle-mascot" src="{{ url_for('static', filename='img/kiss.png') }}" alt="Turtle Mascot" class="h-40 w-auto pointer-events-none" />
  </div>

  <script type="application/json" id="itinerary-json">{{ payload | tojson }}</script>
</section>
{% endblock %}

{% block scripts %}
<script>
(function () {
  const grid      = document.getElementById('plans-grid');
  const mapCol    = document.getElementById('map-col');
  const backBtn   = document.getElementById('back-btn');
  const rawNode   = document.getElementById('itinerary-json');
  const rawBlock  = document.getElementById('raw-block');
  const rawPre    = document.getElementById('raw-pre');

  const CITY    = localStorage.getItem('tt.city') || '';
  const COUNTRY = localStorage.getItem('tt.country_name') || '';

  // Title
  const titleEl = document.getElementById('trip-title');
  if (CITY) titleEl.textContent = `your trip around ${CITY.toLowerCase()}!`;
  else if (COUNTRY) titleEl.textContent = `your trip around ${COUNTRY.toLowerCase()}!`;
  else titleEl.textContent = 'your trips!';

  // ---- recover AI output ----
  let rawText = "";
  try { rawText = JSON.parse(rawNode.textContent || '""'); } catch { rawText = ""; }
  function extractJSON(text) {
    if (!text) return null;
    let t = text.trim();
    const fenced = t.match(/```(?:json)?([\s\S]*?)```/i);
    if (fenced) t = fenced[1].trim();
    const first = t.indexOf('{');
    const last  = t.lastIndexOf('}');
    if (first > -1 && last > -1) t = t.slice(first, last + 1);
    try { return JSON.parse(t); }
    catch { try { return JSON.parse(t.replace(/,\s*([}\]])/g, '$1')); } catch { return null; } }
  }
  const data = extractJSON(rawText);
  if (!data || !Array.isArray(data.travel_plans)) {
    rawBlock.classList.remove('hidden');
    rawPre.textContent = rawText || "(no content)";
    return;
  }

  // ---- session cache helpers ----
  const mem = new Map();
  const cacheGet = k => { const s = sessionStorage.getItem(k); return s ? JSON.parse(s) : null; }
  const cacheSet = (k,v) => { try { sessionStorage.setItem(k, JSON.stringify(v)); } catch{} }

  // =====================================================================
  // REPLACEMENT: Google Places Photos (instead of Wikipedia)
  // =====================================================================
  let __placesService = null;
  function getPlacesService() {
    if (__placesService) return __placesService;
    __placesService = new google.maps.places.PlacesService(document.createElement('div'));
    return __placesService;
  }

  function placesTextSearch(query) {
    return new Promise((resolve) => {
      getPlacesService().textSearch({ query }, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && Array.isArray(results)) {
          resolve(results);
        } else {
          resolve([]);
        }
      });
    });
  }

  function placesGetDetails(placeId) {
    return new Promise((resolve) => {
      getPlacesService().getDetails(
        { placeId, fields: ['name','photos'] },
        (place, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK && place) resolve(place);
          else resolve(null);
        }
      );
    });
  }

  async function fetchPlacePhotoForQuery(query) {
    const ck = `gphoto:${query.toLowerCase()}`;
    const cached = cacheGet(ck);
    if (cached !== null) return cached;

    const results = await placesTextSearch(query);

    // Prefer a result that already has photos inline
    for (const r of results) {
      if (Array.isArray(r.photos) && r.photos.length) {
        const url = r.photos[0].getUrl({ maxWidth: 1200, maxHeight: 800 });
        const out = { url, name: r.name || '', attributions: r.photos[0].html_attributions || [] };
        cacheSet(ck, out);
        return out;
      }
    }

    // Otherwise try details for the top result
    if (results[0]?.place_id) {
      const det = await placesGetDetails(results[0].place_id);
      if (det?.photos?.length) {
        const url = det.photos[0].getUrl({ maxWidth: 1200, maxHeight: 800 });
        const out = { url, name: det.name || '', attributions: det.photos[0].html_attributions || [] };
        cacheSet(ck, out);
        return out;
      }
    }

    cacheSet(ck, null);
    return null;
  }

  async function findImageForSpot(spot) {
    if (!spot) return null;
    const tries = [
      [spot, CITY, COUNTRY].filter(Boolean).join(' '),
      [spot, CITY].filter(Boolean).join(' '),
      spot
    ];
    for (const q of tries) {
      const res = await fetchPlacePhotoForQuery(q);
      if (res?.url) return res;
    }
    return null;
  }
  // =====================================================================

  // ---- tiny helpers ----
  const el = (tag, cls, text)=>{ const n=document.createElement(tag); if(cls) n.className=cls; if(text!=null) n.textContent=text; return n; };

  function activityItem(act){
    const li = el('li','bg-white rounded-lg border overflow-hidden fade-in');
    const imgWrap = el('div','relative w-full h-40 bg-slate-100');
    const img = el('img','w-full h-full object-cover absolute inset-0 hidden');
    img.alt = act.spot || 'activity';
    img.loading = 'lazy';
    imgWrap.appendChild(img);

    if (act.time_of_day) {
      const badge = el('div','absolute top-2 left-2 text-[10px] px-2 py-1 rounded-full bg-white/90 border');
      badge.textContent = act.time_of_day;
      imgWrap.appendChild(badge);
    }

    const body = el('div','p-3');
    body.appendChild(el('div','text-sm font-medium', act.spot || '(unspecified spot)'));
    if (act.description) body.appendChild(el('p','text-sm text-slate-600 mt-1', act.description));

    li.appendChild(imgWrap);
    li.appendChild(body);

    (async () => {
      try {
        const hit = await findImageForSpot(act.spot);
        if (hit?.url) {
          img.src = hit.url;
          img.classList.remove('hidden');
          // Optional: show small attribution
          if (hit.attributions && hit.attributions.length) {
            const attr = el('div','absolute bottom-1 right-1 text-[10px] bg-black/60 text-white px-1.5 py-0.5 rounded');
            attr.innerHTML = 'photo';
            imgWrap.appendChild(attr);
          }
        } else {
          const ph = el('div','absolute inset-0 flex items-center justify-center text-xs text-slate-500');
          ph.textContent='no image found';
          imgWrap.appendChild(ph);
        }
      } catch {}
    })();

    return li;
  }

  function renderPlanCard(plan, idx){
    // clickable card = "use this plan"
    const card = el(
      'div',
      'plan-card relative bg-white/80 rounded-2xl p-5 shadow-sm flex flex-col gap-4 transition transform cursor-pointer hover:-translate-y-0.5 hover:shadow-lg hover:ring-2 hover:ring-emerald-400 opacity-0 translate-y-4 duration-500'
    );
    card.tabIndex = 0;

    requestAnimationFrame(() => {
      card.classList.remove('opacity-0', 'translate-y-4');
    });

    // header + copy json pill
    const header = el('div','pr-28');
    const titleWrap = el('div');
    titleWrap.appendChild(el('h2','text-lg font-bold', plan.plan_name || `Plan ${idx+1}`));
    if (plan.plan_description) titleWrap.appendChild(el('p','text-sm text-slate-600 mt-1', plan.plan_description));
    header.appendChild(titleWrap);

    const actions = el('div','absolute top-4 right-4 flex gap-2');
    const copyBtn = el('button','px-2.5 py-1 text-xs border rounded-lg hover:bg-slate-50 transition','copy plan json');
    actions.appendChild(copyBtn);

    const headWrap = el('div','relative');
    headWrap.appendChild(header);
    headWrap.appendChild(actions);
    card.appendChild(headWrap);

    // per-day layout (your older layout)
    (plan.daily_plan || []).forEach(day => {
      const box = el('div','rounded-xl border p-4 space-y-3');
      const top = el('div','flex items-baseline justify-between gap-2');
      const left= el('div','font-semibold', `day ${day.day ?? ''}${day.date ? ` — ${day.date}` : ''}`);
      const theme = day.theme ? el('div','text-xs text-slate-600 italic', day.theme) : null;
      top.appendChild(left);
      if (theme) top.appendChild(theme);
      box.appendChild(top);

      const list = el('ul','grid gap-3');
      (day.activities || []).forEach(a => list.appendChild(activityItem(a)));
      box.appendChild(list);
      card.appendChild(box);
    });

    copyBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      navigator.clipboard.writeText(JSON.stringify(plan, null, 2));
      copyBtn.textContent = 'copied!';
      copyBtn.classList.add('scale-110','bg-emerald-100','text-emerald-800','transition','duration-200');
      setTimeout(()=>{
        copyBtn.textContent='copy plan json';
        copyBtn.classList.remove('scale-110','bg-emerald-100','text-emerald-800');
      },1000);
    });

    card.addEventListener('click', () => choosePlan(idx, card, plan));
    card.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); choosePlan(idx, card, plan); }
    });

    return card;
  }

  // initial render
  data.travel_plans.forEach((p,i)=> grid.appendChild(renderPlanCard(p,i)));

  // ---- selection mode + sticky sync ----
  let chosenIndex = null;
  let heightObserver = null;
  let heightAdjust = null;

  function enableStickySync(card){
    const adjust = () => { mapCol.style.minHeight = card.getBoundingClientRect().height + 'px'; };
    heightAdjust = adjust;
    try { heightObserver?.disconnect(); heightObserver = new ResizeObserver(adjust); heightObserver.observe(card); } catch {}
    adjust();
    window.addEventListener('resize', adjust);
  }
  function disableStickySync(){
    try { heightObserver?.disconnect(); } catch {}
    heightObserver = null;
    if (heightAdjust) window.removeEventListener('resize', heightAdjust);
    heightAdjust = null;
    mapCol.style.minHeight = '';
  }

  function choosePlan(idx, card, plan){
    if (chosenIndex !== null) return;
    chosenIndex = idx;

    const allCards = Array.from(grid.children);
    allCards.forEach(c=>{
      if (c !== card) {
        c.classList.add('opacity-0','pointer-events-none','transition-opacity','duration-300');
        setTimeout(()=> c.classList.add('hidden'), 300);
      } else {
        c.classList.add('ring-1','ring-emerald-200');
      }
    });

    grid.classList.remove('md:col-span-2','md:grid-cols-2');
    grid.classList.add('md:col-span-1','md:grid-cols-1');
    mapCol.classList.remove('hidden');

    // ✨ smooth fade-in map
    requestAnimationFrame(() => {
      mapCol.classList.remove('opacity-0');
    });

    backBtn.classList.remove('hidden');
    grid.innerHTML = '';
    card.classList.remove('hidden','opacity-0','pointer-events-none');
    grid.appendChild(card);

    enableStickySync(card);
    initMapForPlan(plan);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  backBtn.addEventListener('click', resetView);
  function resetView(){
    chosenIndex = null;
    disableStickySync();
    mapCol.classList.add('hidden');
    mapCol.classList.remove('md:block');
    backBtn.classList.add('hidden');
    grid.innerHTML = '';
    grid.classList.remove('md:col-span-1','md:grid-cols-1');
    grid.classList.add('md:col-span-2','md:grid-cols-2');
    data.travel_plans.forEach((p,i)=> grid.appendChild(renderPlanCard(p,i)));
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // ---- mascot quips + footer avoidance
  document.addEventListener('DOMContentLoaded', () => {
    const mascotWrapper = document.getElementById('turtle-mascot-wrapper');
    const speechEl = document.getElementById('turtle-speech');
    const footer = document.querySelector('footer');

    const phrases = [
      "sea-ze the day!", "turtley excellent!", "fin-tastic picks!",
      "shell yeah!", "you're on the right shell!", "these plans are turtley rad!"
    ];
    speechEl.textContent = phrases[Math.floor(Math.random() * phrases.length)];

    window.addEventListener('scroll', () => {
      if (!mascotWrapper || !footer) return;
      const footerRect = footer.getBoundingClientRect();
      const windowHeight = window.innerHeight;
      const overlap = windowHeight - footerRect.top;
      mascotWrapper.style.bottom = overlap > 0 ? `${overlap + 24}px` : '3rem';
    });
  });

  // ---- Google Maps + Places loader (note libraries=places)
  const MAPS_KEY = "***REMOVED***";
  let mapsLoaded = !!(window.google && window.google.maps);

  function loadMapsOnce(){
    return new Promise((resolve) => {
      if (mapsLoaded) return resolve();
      if (!MAPS_KEY) return resolve();
      const s = document.createElement('script');
      s.src = `https://maps.googleapis.com/maps/api/js?key=${MAPS_KEY}&libraries=places`;
      s.async = true;
      s.onload = ()=>{ mapsLoaded = true; resolve(); };
      s.onerror= ()=> resolve();
      document.head.appendChild(s);
    });
  }

  // ---- Map init (shows ALL markers; dedup by spot; fits bounds)
  async function initMapForPlan(plan){
    await loadMapsOnce();
    const mapDiv = document.getElementById('map');
    mapDiv.innerHTML = '';

    if (!(window.google && google.maps)) {
      const txt = document.createElement('div');
      txt.className = 'p-4 text-sm text-slate-600';
      txt.textContent = 'Map unavailable (missing or invalid Google Maps API key).';
      mapDiv.appendChild(txt);
      return;
    }

    const map = new google.maps.Map(mapDiv, {
      center: { lat: 0, lng: 0 }, zoom: 2,
      mapTypeControl: false, streetViewControl: false, fullscreenControl: false
    });
    const geocoder = new google.maps.Geocoder();
    const bounds = new google.maps.LatLngBounds();

    // flatten activities
    const acts = (plan.daily_plan || []).flatMap(day =>
      (day.activities || []).map(a => ({...a, day: day.day, date: day.date}))
    );

    // dedupe by spot (first occurrence wins)
    const bySpot = new Map();
    for (const a of acts) {
      const key = (a.spot || '').trim().toLowerCase();
      if (key && !bySpot.has(key)) bySpot.set(key, a);
    }

    let pointCount = 0;

    for (const a of bySpot.values()) {
      const queries = [
        [a.spot, CITY, COUNTRY].filter(Boolean).join(', '),
        [a.spot, CITY].filter(Boolean).join(', '),
        a.spot
      ];

      let loc = null;
      for (const q of queries) {
        try {
          const ck = `geo:${q.toLowerCase()}`;
          const cached = sessionStorage.getItem(ck);
          if (cached) { loc = JSON.parse(cached); break; }

          const { results } = await geocoder.geocode({ address: q });
          if (results && results[0]) {
            const p = results[0].geometry.location;
            loc = { lat: p.lat(), lng: p.lng() };
            sessionStorage.setItem(ck, JSON.stringify(loc));
            break;
          }
        } catch {}
      }

      if (!loc) continue;

      const latLng = new google.maps.LatLng(loc.lat, loc.lng);
      new google.maps.Marker({ position: latLng, map, title: a.spot });
      bounds.extend(latLng);
      pointCount++;
    }

    if (pointCount > 0) {
      map.fitBounds(bounds);
      if (map.getZoom() > 15) map.setZoom(15);
    } else {
      try {
        const { results } = await geocoder.geocode({ address: [CITY, COUNTRY].filter(Boolean).join(', ') });
        if (results && results[0]) {
          map.setCenter(results[0].geometry.location);
          map.setZoom(11);
        }
      } catch {}
    }
  }
})();
</script>
{% endblock %}
